// ====================================
// DATABASE OF STORIES
// ====================================
const database = {
    'korazon': {
        name: 'KORAZON',
        subtitle: 'THE HEARTLESS CHILD',
        img: 'assets/icons/mara3.png',
        story: `
            <span class="story-paragraph">
                <strong>Korazon</strong> naquit dans les ruelles de Namakura, une île où la faim valait plus que l’or et où les dieux, s’ils existaient, avaient détourné le regard. Étant un enfant abandonné, il survécut dans un monde de misère et de violence, avec le ventre creux, ça créera un lieu de prières et surtout que les faibles périssaient.
            
            <span class="story-paragraph">
                <strong>On</strong> l’appela Korazon, avec beaucoup d'ironie, car il n’avait pas de cœur. Pas de pitié, pas de tendresse, et surtout rien dans son regard. Dès son plus jeune âge, il apprit que la confiance est un sacré luxe et que la loyauté mène au cimetière. Il volait, poignardait, trahissait, et la peur devint son instrument.
            </span>

            <span class="story-paragraph">
                <strong>À l’adolescence</strong>, Korazon n’était plus un enfant, mais un prédateur, montant dans la chaîne alimentaire. Il fonda son propre groupe de bandits, imposant sa loi par la terreur. La famine devint un outil de contrôle, finalement, ceux qui servaient survivaient, les autres disparaissaient dans les abysses de la mer. Il jouait avec les croyances de chacun et superstitions de l’île, laissant croire que les spectres lui obéissaient, quand en réalité, il n’avait besoin de personne.
            </span>
            
            <div class="story-dialogue">
                « Brise ta couronne. Le pouvoir véritable n’attend que dans le sang des tiens. »
            </div>

            <span class="story-paragraph">
                <strong>À</strong> seulement vingt ans, Korazon régnait sur partie de Namakura. Mais cette partie, rempli de ruines et de misère qui règne, elle était trop petite pour un homme de son ambition. Une nuit, durant une réunion, il exécuta ses hommes, un massacre calculé qui démontrait que le véritable spectre de l’île était lui-même, des rumeurs disent que les ruelles étaient rouges.
            </span>

            <span class="story-paragraph">
                <strong>Lorsque</strong> la Marine arriva, les habitants trahirent le tyran, ils virent une chance pour sa sauver de la misère, et enfin se débarrasser de celui qu’ils avaient craint. Korazon ne fut pas surpris, car une révolution se crée souvent via la fragilité du peuple. Mais cette trahison affûta sa volonté, s’il voulait régner, il lui fallait un royaume à la mesure de son ambition. Il prit un navire et quitta Namakura, non en fugitif, mais en conquérant.
            </span>

            <span class="story-paragraph">
                <strong>Ainsi</strong> naquit le pirate Korazon, stratège sans pitié, maître de la terreur et fondateur de l’équipage Most Wanted. Son royaume désormais n’aurait plus de frontières. Son but premier était de trouver ces futurs membres, il lui fallait un rendez pour chacun, à Logue Town, l'endroit où les légendes s'éveillent. En l’an 1496, le 6/11, il ne reste à Korazen que 5 ans et 1 mois pour rassembler les futures légendes et montrer au monde toute sa puissance.
            </span>

            <div class="story-date-container">
                <span class="story-date">06 NOVEMBRE 1496</span>
                <span class="story-time">TEMPS RESTANT : 5 ANS ET 1 MOIS</span>
            </div>

            <div class="story-quote">
                <p>« Dans un monde de misère et de trahison, nous ne suivons ni loi, ni roi. Nous forgeons notre empire dans le sang et l’ombre… et seuls les audacieux nous appellent alliés. »</p>
                <footer>- KORAZON</footer>
            </div>
        `
    },
    'elio': {
        name: 'ELIO VIRELLI',
        subtitle: 'THE PALE RIDER',
        img: 'assets/icons/cieven2.png',
        story: `
            <span class="story-paragraph">
                <strong>Elio Virelli</strong> naquit dans une famille de chercheurs anonymes, mais le monde ne tarda pas à découvrir qu’il n’était pas simplement brillant, il était dangereux. Car dès son adolescence, il développa une fascination maladive pour la douleur humaine, et non par cruauté, mais par curiosité scientifique. Il disséquait les animaux, étudiait les réactions du cerveau à la peur, et parlait à des voix que personne d’autre n’entendait. Peu à peu, la frontière entre génie et folie se brisa en lui.
            </span>
            
            <span class="story-paragraph">
                <strong>Nika</strong>. c'est le nom que les voix lui révélèrent. Bizarrement, il ne vit celui-ci comme un dieu de la liberté, mais une version tordue, reconstruite, réinterprétée, pour lui c’était un algorithme cosmique, un moteur de chaos, un plan mathématique derrière la souffrance humaine.
            </span>

            <span class="story-paragraph">
                <strong>Et</strong> il décida… de devenir son prophète. À vingt ans, il renversa une petite île isolée, utilisant la terreur, les expériences, et une poignée de fanatiques recrutés parmi les marginaux. Il imposa son règne comme un scientifique tyrannique, opérant sur les habitants au nom de son dieu imaginaire, envoyant des lettres incohérentes à une mystérieuse personne sur Namakura, des lettres remplies de schémas, des écrits, des prophéties.
            </span>

            <span class="story-paragraph">
                <strong>Mais</strong> la trahison vint de l’intérieur. Ses propres disciples, écœurés, le capturèrent et l’empalèrent. En l’an 1497, 23/06, Elio resta cinq jours ainsi, sans boire, sans manger, entre vie et mort, ses lèvres gercées étirées en un rire démentiel qui ne voulait pas mourir, chaque jour, son rire se fit entendre dans tout le camp. Le sixième jour, alors que son cœur battait faiblement, une véritable trompette retentit, et non une vision, tout simplement un homme apparut dans le contre-jour, buvant dans sa bouteille en souriant en regardant Elio.
            </span>

            <div class="story-dialogue">
                « Brise ta couronne. Le pouvoir véritable n’attend que dans le sang des tiens. »
            </div>

            <span class="story-paragraph">
                <strong>Korazon</strong> avancera, allumera son briquet et brulera des lettres, c'était celle d'Elio qu'il envoyait chaque semaine. Il le détacha sans un mot. Il le laissa tomber au sol, lui jeta de l’eau glacée sur le visage, puis le releva par le col, leurs regards à hauteur égale. Elio, à moitié mort, éclata de rire en rougissant. Un rire tellement fort qu'il semblait briser une côte à chaque secousse. Korazon ne recula pas. Il posa une main sur son épaule, le fixa, et dit :
            </span>

            <div class="story-dialogue">
                « Lève-toi, frère. Le Monde t'attend. »
            </div>

            <span class="story-paragraph">
                <strong>Elio</strong> cessa de rire. Nous sommes en l’an 1497, 28/06, un instant, il vit ou crut voir les lignes du destin se tordre autour de Korazon comme des serpents d’ombre. Il n’eut pas besoin d’en savoir plus. Il n’eut pas besoin de comprendre. Il accepta. Car il ne suivait pas un capitaine… Il suivait le seul homme dont la folie dépassait la sienne. La seule condition était d'attendre les nouvelles recrues, les futurs conquérants de ses mers. C'est ici que le Most Wanted s'officilisera...
            </span>

            <span class="story-paragraph">
                <strong>Le</strong>capitaine donnera un rendez-vous sur Logue Town, dans précisément 4 ans et 5 mois et 8 jours, jour pour jour, le Most Wanted s'éveillera à ce moment, une nouvelle ère débutera, et le duo élevera la piraterie avec l'équipage. Elio Virelli est devenu le chirurgien du chaos, le terroriste, le scientifique dément et le prophète de son propre dieu imaginaire. Sous le pavillon des Most Wanted, sa science n’a plus de limites, et sa voix résonne encore sur les mers, son rire se fit entendre à chaque endroit que le Most Wanted fit une action, portée par ses éclats de rire et ses visions.
            </span>

            <div class="story-date-container">
                <span class="story-date">DATE : 28 JUIN 1497</span>
                <span class="story-time">TEMPS RESTANT AVANT L'ÉVEIL : 4 ANS, 5 MOIS ET 8 JOURS</span>
            </div>

            <div class="story-quote">
                <p>« La souffrance n’est pas une erreur… c’est un langage. Et moi, j’en suis le traducteur. »</p>
                <footer>- ELIO VIRELLI</footer>
            </div>
        `
    },
    'blanc': {
        name: 'LANCELOT',
        subtitle: 'THE FALLEN PRINCE',
        img: 'assets/icons/blanc2.png',
        story: `
            <span class="story-paragraph">
                <strong>Lancelot de Beaumont</strong> naquit à Loguetown, la ville où naissent et meurent les légendes. Fils de marchands, il fut élevé comme un prince, dans un confort où le bonheur était la normalité et la douleur une simple rumeur lointaine.
            </span>
            
            <span class="story-paragraph">
                Cette illusion se brisa le jour où des pirates attaquèrent la ville. Lancelot, terrifié, se réfugia dans les bas-fonds. Pendant qu’il tremblait dans l’ombre, ses parents furent capturés, utilisés comme monnaie d’échange… puis exécutés.
            </span>

            <span class="story-paragraph">
                En l’an 1496, le <strong>01/09</strong>, Lancelot revint chez lui et ne trouva que le silence. Il attendit des jours, puis une semaine. Affamé et seul, il comprit qu'ils ne reviendraient jamais. La chaleur de son enfance s’effondra, remplacée par un vide dévorant. Désespéré, il décida de mettre fin à ses jours.
            </span>

            <div class="story-dialogue">
                « Souviens-toi toujours, Lancelot… dans ce monde, le plus précieux n’est pas ce que l’on possède, mais ce que l’on protège… »
            </div>

            <span class="story-paragraph">
                Alors qu’il s’apprêtait à franchir le seuil, une silhouette apparut dans l'ombre : <strong>Korazon</strong>. Son regard transperça Lancelot comme une lame. Il rit en le voyant. Pas de compassion, pas de destin. Il parla de vérité, de vengeance et de puissance.
            </span>

            <span class="story-paragraph">
                Il lui dit que ses parents pouvaient être vengés. Que les responsables pouvaient brûler. Il lui tendit une main. Pas celle d’un sauveur, mais celle d’un homme offrant un chemin sanglant. Lancelot accepta, car il n’avait plus rien.
            </span>

            <span class="story-paragraph">
                Le garçon choyé de Loguetown mourut ce jour-là pour laisser naître un nouveau visage du <strong>Most Wanted</strong>. Korazon abandonna une carte au sol avant de partir.
            </span>

            <div class="story-date-container">
                <span class="story-date">DATE : 01 SEPTEMBRE 1496</span>
                <span class="story-time">TEMPS RESTANT : 1 AN, 3 MOIS ET 5 JOURS</span>
            </div>

            <div class="story-quote">
                <p>« La perte m’a appris une seule vérité : le monde ne pardonne pas. Alors moi non plus, je ne pardonnerai jamais. »</p>
                <footer>- LANCELOT DE BEAUMONT</footer>
            </div>
        `
    },

    'noir': {
        name: 'CAÏN',
        subtitle: 'THE CURSED PROPHET',
        img: 'assets/icons/noir2.png',
        story: `
            <span class="story-paragraph">
                <strong>Caïn</strong> naquit sur l’île isolée de Namakura, dans l’archipel de Sanctaris. Dès sa naissance, les prêtres de L’Ordre du Premier Péché remarquèrent une marque rouge sombre sur son corps, symbole du meurtrier mythique.
            </span>
            
            <span class="story-paragraph">
                Élevé dans le fanatisme, Caïn grandit convaincu que sa vie était liée à un destin inexorable. Ses journées étaient rythmées par les rituels et l'étude des Cartes du Destin. Mais à 14 ans, lors d'un rituel, les effigies sacrées s’animèrent et massacrèrent les prêtres. Caïn survécut, seul, couvert du sang de ses confrères.
            </span>

            <span class="story-paragraph">
                En l’an 1499, le <strong>06/03</strong>, à 19 ans, il quitta Sanctaris. Hué et menacé, il se fit agresser. Alors que le sang coulait sur sa marque qui s'illuminait, il pria pour être sauvé.
            </span>

            <div class="story-dialogue">
                « Même marqué par le péché, mon enfant, tu n’es jamais condamné tant que tu observes les signes... »
            </div>

            <span class="story-paragraph">
                Un coup de fusil retentit. Ce n'était pas la mort, mais <strong>Korazon</strong>. Il cracha par terre, essuya le sang sur sa veste et se moqua de la situation. Il ne voyait pas Caïn comme un maudit, mais comme une pièce maîtresse.
            </span>

            <span class="story-paragraph">
                Aujourd’hui, Caïn navigue en tant que divinateur du <strong>Most Wanted</strong>. Stoïque et fataliste, il reçut une dernière lettre de son capitaine en fuite. Il nota le lieu du rendez-vous au dos de l'Arcane 13.
            </span>

            <div class="story-date-container">
                <span class="story-date">DATE : 06 MARS 1499</span>
                <span class="story-time">TEMPS RESTANT : 2 ANS ET 9 MOIS</span>
            </div>

            <div class="story-quote">
                <p>« Le destin n’est pas un choix, mais une équation que seuls les patients peuvent résoudre. »</p>
                <footer>- CAÏN "LE MAUDIT"</footer>
            </div>
        `
    },

    'rouge': {
        name: 'SIR JULIUS',
        subtitle: 'THE MOON TYRANT',
        img: 'assets/icons/rouge2.png',
        story: `
            <span class="story-paragraph">
                <strong>Sir Julius</strong> et sa jumelle Alune naquirent lors d’une convergence lunaire au Mont Targon. Le culte des Lunaris les attendait depuis des générations. Julius reçut le don de la lune de pierre, une aura froide absorbant la lumière.
            </span>
            
            <div class="story-dialogue">
                « Deux enfants, une seule lune. L’un de pierre, l’autre de lumière. »
            </div>

            <span class="story-paragraph">
                Cachés des Solaris qui les traquaient, ils grandirent dans l'ombre. Mais en l'an 1499, le <strong>12/12</strong>, les Solaris découvrirent leur cachette et massacrèrent tout le monde. Julius et Alune s'enfuirent, jurant de reprendre ce qui avait été volé.
            </span>

            <span class="story-paragraph">
                Julius rallia les survivants et mena une guérilla sans merci. Au 6ème jour, épuisés et encerclés dans une grotte, tout semblait fini. C’est alors que quatre coups de fusil résonnèrent. Une silhouette acheva les soldats Solaris : <strong>Korazon</strong>, venu suivre une rumeur de prophétie.
            </span>

            <span class="story-paragraph">
                Il alluma une cigarette, éclairant son visage, puis repartit sans un mot. Ce geste suffit. Les Lunaris triomphèrent le lendemain. Mais le règne de Julius devint un hiver sans fin, une tyrannie née de la vengeance.
            </span>

            <span class="story-paragraph">
                Assis sur son trône, il reçut une pierre marquée d’une inscription au sang. Julius sourit en regardant sa sœur.
            </span>

            <div class="story-date-container">
                <span class="story-date">DATE : 18 DÉCEMBRE 1499</span>
                <span class="story-time">TEMPS RESTANT : 5 MOIS ET 18 JOURS</span>
            </div>

            <div class="story-quote">
                <p>« Je n’ai pas choisi l’ombre. C’est la lumière qui m’a tourné le dos. »</p>
                <footer>- SIR JULIUS</footer>
            </div>
        `
    },

    'c_blanc??': {
        name: '???',
        subtitle: 'CAVALIER BLANC',
        img: 'assets/icons/blanc4.png',
        story: `
            <span class="story-paragraph">
                <strong>?</strong>?????????????????? ??????????????????????????????????????????? ????????????????????????????????????? ???????????????????????????????????????
            </span>
            
            <span class="story-paragraph">
                <strong>?</strong>???????????????? ?????????????????????? ??????????????????????????????????????? ???????????????????????????????????? ????????????????? ???????????????????????
            </span>

            <div class="search-ia-monologue">
                « <strong>[SCANNING_SECTOR_WHITE]... [VIBRATION_DETECTED]...</strong> Le silence de la domination s'installe. Le système identifie une signature royale. Cible verrouillée : celui qui ne recule jamais avant la victoire totale. »
            </div>

            <span class="story-paragraph">
                <strong>?</strong>???????? ?????????????????????????????????? ??????????????????????????? ???????????????????????????????????? ??????????????????????
            </span>
            
            <span class="story-paragraph">
                <strong>?</strong>???????? ??????????????????? ?????????????????????????????????? ??????????????????????? ????????????????????????????????
            </span>

            <div class="story-date-container">
                <span class="story-date">DATE : ????</span>
                <span class="story-time">TEMPS RESTANT : ??????</span>
            </div>

            <div class="story-quote">
                <p>« Je regardai donc, et je vis un cheval blanc, et celui qui était monté dessus avait un arc, et on lui donna une couronne, et il partit en vainqueur, pour remporter la victoire. »</p>
                <footer>- APOCALYPSE 6:2</footer>
            </div>
        `
    },
    'c_noir??': {
        name: '???',
        subtitle: 'CAVALIER NOIR',
        img: 'assets/icons/noir4.png',
        story: `
            <span class="story-paragraph">
                <strong>?</strong>?????????????????????????? ??????????? ??????????????? ???????????????????????? ????????????????????????????????????????????????? ????????????????????????
            </span>
            
            <span class="story-paragraph">
                <strong>?</strong>???????????????? ???????????????????????????????????? ??????????????? ?????????????????????????????????????????????????????????????????? ????????????????? ???????????????????????
            </span>

            <div class="search-ia-monologue">
                « <strong>[CORE_TEMP_CRITICAL]... [SIGNAL_RED_OVERFLOW]...</strong> La paix est effacée de la mémoire vive. Le fer appelle le fer. Recherche d'un signal de destruction pure. Le monde s'apprête à s'égorger. »
            </div>

            <span class="story-paragraph">
                <strong>?</strong>??????????????????????? ??????????????????? ??????????????? ??????????????????????????? ?????????????????????? ????????????? ?????????????????
            </span>
            
            <span class="story-paragraph">
                <strong>?</strong>???? ???????????? ?????????????????????? ?????????????????????????????????????? ?????????????????????????????
            </span>

            <div class="story-date-container">
                <span class="story-date">DATE : ????</span>
                <span class="story-time">TEMPS RESTANT : ??????</span>
            </div>

            <div class="story-quote">
                <p>« Et il sortit un autre cheval qui était roux ; et celui qui le montait reçut le pouvoir de bannir la paix de la terre, et de faire que les hommes se tuassent les uns les autres ; et on lui donna une grande épée. »</p>
                <footer>- APOCALYPSE 6:4</footer>
            </div>
        `
    },
    'c_rouge??': {
        name: '???',
        subtitle: 'CAVALIER ROUGE',
        img: 'assets/icons/rouge4.png',
        story: `
            <span class="story-paragraph">
                <strong>?</strong>????????????????????????????????????????? ???????????????????? ????????????????????????????????????????????????????????? ??????????????????? ???????????????????
            </span>
            
            <span class="story-paragraph">
                <strong>?</strong>???????????? ???? ?????????????????????? ????????????????? ?????????????????????? ?????????????????????????????? ????????????????????? ????????????????? ?????????????????????????????????????????????????????
            </span>

            <div class="search-ia-monologue">
                « <strong>[RESOURCES_DEPLETED]... [MARKET_CRASH_DETECTED]...</strong> La balance oscille dans le vide. Le prix de la vie dépasse les réserves du système. Traçage d'une silhouette tenant le poids de notre survie entre ses doigts. »
            </div>

            <span class="story-paragraph">
                <strong>?</strong>???????????????????????????????????? ?????? ?????????????? ????????????? ???????????????????????????????? ??????????????????? ??????????????????????
            </span>
            
            <span class="story-paragraph">
                <strong>?</strong>????????????????????? ????????????????????? ?????????????? ???????????????????? ????????????? ?????????? ???????????????????????????????????????????????
            </span>

            <div class="story-date-container">
                <span class="story-date">DATE : ????</span>
                <span class="story-time">TEMPS RESTANT : ??????</span>
            </div>

            <div class="story-quote">
                <p>« Et quand l’Agneau eut ouvert le troisième sceau, j’entendis le troisième animal, qui disait : Viens et vois. Et je regardai, et il parut un cheval noir, et celui qui était monté dessus avait une balance à la main. »</p>
                <footer>- APOCALYPSE 6:5</footer>
            </div>
        `
    }
};

// ====================================
// INITIALIZE LUCIDE ICONS AND GSAP
// ====================================
document.addEventListener('DOMContentLoaded', function() {
    lucide.createIcons();
    gsap.registerPlugin(ScrollTrigger);

    // Initialize custom cursor
    initCustomCursor();
    
    // Initialize 3D tilt effects
    init3DTilt();
    
    // Generate ASCII background
    generateASCIIBackground();
    
    // Initialize scroll animations
    initScrollAnimations();

    initHackEffects();

    initLoginSystem();
});

// ====================================
// CUSTOM CURSOR SYSTEM
// ====================================
function initCustomCursor() {
    const cursorSystem = document.getElementById('cursor-system');
    const reticle = cursorSystem.querySelector('.cursor-reticle');
    const spotlight = document.getElementById('spotlight');
    const label = cursorSystem.querySelector('.cursor-label');

    window.addEventListener('mousemove', (e) => {
        if (window.matchMedia("(pointer: coarse)").matches) return;

        const x = e.clientX;
        const y = e.clientY;

        cursorSystem.style.left = `${x}px`;
        cursorSystem.style.top = `${y}px`;

        spotlight.style.setProperty('--x', `${x}px`);
        spotlight.style.setProperty('--y', `${y}px`);
        
        if (Math.random() > 0.9) {
            const randX = Math.floor(x + Math.random() * 10);
            const randY = Math.floor(y + Math.random() * 10);
            label.textContent = `TARGET [${randX},${randY}]`;
        }
    });

    // Hover state for cursor
    document.querySelectorAll('a, button, .cyber-card, .tilt-content, .group').forEach(el => {
        el.addEventListener('mouseenter', () => {
            if (window.matchMedia("(pointer: coarse)").matches) return;
            document.body.classList.add('hovering');
            label.textContent = "LOCKING ON...";
        });
        el.addEventListener('mouseleave', () => {
            if (window.matchMedia("(pointer: coarse)").matches) return;
            document.body.classList.remove('hovering');
            label.textContent = "SCANNING...";
        });
    });
}

// ====================================
// 3D TILT EFFECT
// ====================================
function init3DTilt() {
    document.querySelectorAll('.tilt-box').forEach(box => {
        box.addEventListener('mousemove', (e) => {
            if (window.matchMedia("(pointer: coarse)").matches) return;

            const rect = box.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            const centerX = rect.width / 2;
            const centerY = rect.height / 2;
            
            const rotateX = ((y - centerY) / centerY) * -10;
            const rotateY = ((x - centerX) / centerX) * 10;
            
            box.querySelector('.tilt-content').style.transform = 
                `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) translateZ(20px)`;
        });
        
        box.addEventListener('mouseleave', () => {
            if (window.matchMedia("(pointer: coarse)").matches) return;
            box.querySelector('.tilt-content').style.transform = 
                `perspective(1000px) rotateX(0deg) rotateY(0deg) translateZ(0px)`;
        });
    });
}

// ====================================
// NOUVELLE FONCTION TYPEWRITER HTML
// ====================================
// Cette fonction tape le texte mais respecte les balises HTML (strong, div, span)
async function typeHtml(container, htmlContent, speed = 1) { 
    container.innerHTML = ''; 
    
    // Création du curseur "Cube"
    const cursor = document.createElement('span');
    cursor.className = 'typing-cursor';
    container.appendChild(cursor);

    // Parsing du HTML
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = htmlContent;

    // Fonction récursive de frappe
    async function typeNode(node, parent) {
        if (!isTyping) return;
        // --- CORRECTION ICI : On ignore les espaces vides entre les balises ---
        if (node.nodeType === Node.TEXT_NODE && !node.textContent.trim()) {
            return; 
        }

        // Si c'est du texte pur
        if (node.nodeType === Node.TEXT_NODE) {
            const text = node.textContent;
            
            // On tape caractère par caractère
            for (let i = 0; i < text.length; i++) {
                if (!isTyping) return;
                const char = text[i];
                const charNode = document.createTextNode(char);
                parent.insertBefore(charNode, cursor);
                
                // Vitesse variable
                let currentSpeed = speed;
                if (char === '.' || char === ',') currentSpeed += 40; 
                else currentSpeed += Math.random() * 20;

                await new Promise(r => setTimeout(r, currentSpeed));

                // Auto-scroll
                const modal = document.getElementById('story-modal');
                if (modal) {
                    const isNearBottom = modal.scrollHeight - modal.scrollTop - modal.clientHeight < 100;
                    if(isNearBottom) modal.scrollTop = modal.scrollHeight;
                }
            }
        } 
        // Si c'est un élément HTML
        else if (node.nodeType === Node.ELEMENT_NODE) {
            const element = document.createElement(node.tagName);
            
            // Copie des attributs
            Array.from(node.attributes).forEach(attr => {
                element.setAttribute(attr.name, attr.value);
            });

            parent.insertBefore(element, cursor);
            element.appendChild(cursor);

            // On traite les enfants
            for (const child of Array.from(node.childNodes)) {
                await typeNode(child, element);
            }

            parent.appendChild(cursor);
        }
    }

    // Lancement
    for (const child of Array.from(tempDiv.childNodes)) {
        // --- CORRECTION ICI AUSSI : On ne lance pas la frappe pour du vide ---
        if (child.nodeType === Node.TEXT_NODE && !child.textContent.trim()) {
            continue;
        }
        await typeNode(child, container);
    }
}

// ====================================
// STORY MODAL LOGIC (MISE À JOUR)
// ====================================
// Variable globale pour pouvoir stopper l'écriture si on ferme la fenêtre
let isTyping = false; 

function openStory(id) {
    const data = database[id];
    if (!data) return;

    const modal = document.getElementById('story-modal');
    const img = document.getElementById('modal-img');
    const name = document.getElementById('modal-name');
    const subtitle = document.getElementById('modal-subtitle');
    const text = document.getElementById('modal-text');
    const fileId = document.getElementById('modal-id');

    // Reset visuel immédiat
    text.innerHTML = '';
    
    // Infos statiques
    img.src = data.img;
    name.textContent = data.name;
    subtitle.textContent = data.subtitle;
    fileId.textContent = "FILE_" + id.toUpperCase() + "_" + Math.floor(Math.random() * 9999);
    
    // Affichage Modal
    modal.style.display = 'block';
    gsap.to(modal, { opacity: 1, duration: 0.3 });

    // Nettoyage du curseur statique s'il existe dans le HTML de base
    const staticCursor = document.querySelector('.story-text-container .animate-pulse');
    if(staticCursor) staticCursor.style.display = 'none';

    // Démarrage de l'écriture
    isTyping = true;
    
    // On lance un petit délai pour laisser l'animation d'ouverture se faire
    setTimeout(() => {
        if(isTyping) typeHtml(text, data.story, 1); // 5ms de base = rapide
    }, 300);
}

function closeStory() {
    isTyping = false; // Arrête l'écriture si on ferme
    const modal = document.getElementById('story-modal');
    
    gsap.to(modal, { 
        opacity: 0, 
        duration: 0.3, 
        onComplete: () => {
            modal.style.display = 'none';
            document.getElementById('modal-text').innerHTML = ''; // Nettoyer
        } 
    });
}

// ====================================
// NEW INTRO: PASSWORD SYSTEM
// ====================================

function initLoginSystem() {
    const bg = document.getElementById('hint-bg');
    const input = document.getElementById('password-input');
    
    // 1. Générer les indices "Most Wanted" partout
    // On en crée 20 qui apparaissent/disparaissent aléatoirement
    for(let i = 0; i < 20; i++) {
        createHint(bg);
    }

    // 2. Écouter la touche Entrée
    input.addEventListener('keyup', (e) => {
        if (e.key === 'Enter') {
            checkPassword();
        }
    });
}

function createHint(container) {
    const el = document.createElement('div');
    el.classList.add('hint-text');
    el.textContent = "MOST WANTED";
    
    // Position aléatoire
    const x = Math.random() * 100;
    const y = Math.random() * 100;
    // Taille aléatoire
    const size = 10 + Math.random() * 60;
    
    el.style.left = `${x}%`;
    el.style.top = `${y}%`;
    el.style.fontSize = `${size}px`;
    
    container.appendChild(el);

    // Animation GSAP pour faire clignoter l'indice
    gsap.to(el, {
        opacity: Math.random() * 0.4, // Opacité max faible pour ne pas gêner
        duration: 0.1 + Math.random() * 0.5,
        repeat: -1,
        yoyo: true,
        delay: Math.random() * 2,
        onRepeat: () => {
            // Glitch position de temps en temps
            if(Math.random() > 0.8) {
                el.style.left = `${Math.random() * 100}%`;
                el.style.top = `${Math.random() * 100}%`;
            }
        }
    });
}

// ====================================
// LOGIQUE MOT DE PASSE (MISE À JOUR)
// ====================================

let failedAttempts = 0; // Compteur d'échecs

function checkPassword() {
    const input = document.getElementById('password-input');
    const status = document.getElementById('login-status');
    const screen = document.getElementById('intro-screen');
    const main = document.getElementById('main-content');
    
    // Nettoyage de l'entrée
    const cleanValue = input.value.trim().toUpperCase().replace(/\s/g, '');
    
    if (cleanValue === "MOSTWANTED") {
        // --- SUCCÈS ---
        status.textContent = "ACCESS GRANTED. WELCOME.";
        status.style.color = "var(--trinity-red)";
        input.blur();
        
        // Animation de succès
        screen.classList.add('access-granted');
        
        // Transition vers le site
        const tl = gsap.timeline();
        tl.to(".hint-text", { opacity: 0, duration: 0.2 })
          .to(screen, { scaleY: 0.002, duration: 0.4, ease: "power2.inOut", delay: 0.2 })
          .to(screen, { width: 0, duration: 0.3, onComplete: () => {
              screen.style.display = 'none';
              main.classList.remove('hidden');
              gsap.to(main, { opacity: 1, duration: 1 });
              
              // Animation du titre principal
              const split = new SplitType('h1', { types: 'chars' });
              gsap.from(split.chars, { opacity: 0, y: 100, rotateX: 90, stagger: 0.03, duration: 1 });
          }});

    } else {
        // --- ÉCHEC ---
        failedAttempts++;
        input.value = ""; // Vider le champ
        
        // --- SYSTÈME D'INDICES PROGRESSIFS ---
        if (failedAttempts >= 10) {
            // ECHEC CRITIQUE : ON DONNE LA RÉPONSE
            status.innerHTML = "SYSTEM OVERRIDE. PASSWORD: <span class='text-white font-bold'>MOST WANTED</span>";
            status.style.color = "var(--trinity-red)";
            
        } else if (failedAttempts === 9) {
            // DERNIÈRE CHANCE : FORMAT DU MOT
            status.textContent = "DERNIER AVERTISSEMENT : M*** W*****";
            status.style.color = "#ff0000"; // Rouge vif
            
        } else if (failedAttempts >= 7) {
            // INDICE 3 : LANGUE
            status.textContent = "INDICE 3 : C'EST EN ANGLAIS (2 MOTS)";
            status.style.color = "#ff4400"; // Orange foncé
            
        } else if (failedAttempts >= 5) {
            // INDICE 2 : CONTEXTE
            status.textContent = "INDICE 2 : QUEL EST LE NOM DE L'ÉQUIPAGE ?";
            status.style.color = "#ff8800"; // Orange
            
        } else if (failedAttempts >= 3) {
            // INDICE 1 : VISUEL
            status.textContent = "INDICE 1 : REGARDEZ LE TEXTE FLOTTANT EN ARRIÈRE-PLAN";
            status.style.color = "#ffcc00"; // Jaune
            
        } else {
            // 1er et 2ème ESSAI : ERREUR CLASSIQUE
            status.textContent = `ACCESS DENIED. INVALID PASSWORD. (${failedAttempts}/10)`;
            status.style.color = "white";
        }
        
        // Animation de secousse (Shake) inchangée
        const container = input.parentElement;
        container.classList.add('shake-input');
        setTimeout(() => {
            container.classList.remove('shake-input');
        }, 500);
    }
        
        // Animation de secousse (Shake)
        const container = input.parentElement;
        container.classList.add('shake-input');
        
        // Retirer la classe shake après l'animation pour pouvoir la rejouer
        setTimeout(() => {
            container.classList.remove('shake-input');
        }, 500);
    }

// ====================================
// ASCII BACKGROUND GENERATION
// ====================================
function generateASCIIBackground() {
    const container = document.getElementById('ascii-bg');
    const chars = "010101001PROJECT_RED☠️";
    let content = "";
    for(let i=0; i<4000; i++) {
        content += chars[Math.floor(Math.random() * chars.length)];
        if(i % 150 === 0) content += "\n";
    }
    container.innerText = content;
}

// ====================================
// SCROLL ANIMATIONS
// ====================================
function initScrollAnimations() {
    gsap.utils.toArray('section').forEach(sec => {
        gsap.from(sec.children, {
            scrollTrigger: {
                trigger: sec,
                start: "top 80%",
            },
            y: 50,
            opacity: 0,
            duration: 1,
            stagger: 0.1,
            ease: "power3.out"
        });
    });
}

// ====================================
// HACK EFFECT: BOUNTY & STATUS
// ====================================

function initHackEffects() {
    const bountyElement = document.getElementById('bounty-counter');
    const statusElement = document.getElementById('status-text');

    // 1. Effet de nombres aléatoires pour la Prime
    setInterval(() => {
        // Génère un nombre aléatoire massif style One Piece
        const randomBounty = Math.floor(Math.random() * 9999999999).toLocaleString();
        bountyElement.textContent = randomBounty;
        
        // Petit effet de glitch de couleur occasionnel
        if(Math.random() > 0.95) {
            bountyElement.style.textShadow = "2px 0 #fff, -2px 0 var(--trinity-red)";
            setTimeout(() => bountyElement.style.textShadow = "none", 50);
        }
    }, 80); // Vitesse de l'effet de hack

    // 2. Cycle des lieux connus (Lore One Piece)
    const locations = ["SABAODY", "UNKNOWN", "NAMAKURA", "IMPEL DOWN", "LOGUE TOWN", "ALABASTA", "LAUGHTALE?"];
    let locIndex = 0;

    setInterval(() => {
        if(Math.random() > 0.8) { // Changement aléatoire
            locIndex = (locIndex + 1) % locations.length;
            
            // Animation de texte "glitch" lors du changement
            const targetLoc = locations[locIndex];
            let iterations = 0;
            
            const interval = setInterval(() => {
                statusElement.childNodes[0].textContent = targetLoc
                    .split("")
                    .map((char, index) => {
                        if(index < iterations) return targetLoc[index];
                        return String.fromCharCode(65 + Math.floor(Math.random() * 26));
                    })
                    .join("");
                
                if(iterations >= targetLoc.length) clearInterval(interval);
                iterations += 1/3;
            }, 30);
        }
    }, 3000);
}
